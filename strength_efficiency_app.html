<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Strength">
    <meta name="theme-color" content="#0a0a0f">
    <meta name="description"
        content="Find optimal workout combinations based on movement patterns, exercise potency, and synergy">
    <title>Strength Efficiency Optimizer</title>
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icon-192.png">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap"
        rel="stylesheet">
    <style>
        :root {
            --bg-primary: #0a0a0f;
            --bg-secondary: #12121a;
            --bg-tertiary: #1a1a25;
            --bg-card: linear-gradient(145deg, #151520 0%, #1a1a28 100%);
            --accent-primary: #6366f1;
            --accent-secondary: #8b5cf6;
            --accent-gradient: linear-gradient(135deg, #6366f1 0%, #8b5cf6 50%, #a855f7 100%);
            --text-primary: #f8fafc;
            --text-secondary: #94a3b8;
            --text-muted: #64748b;
            --success: #22c55e;
            --warning: #f59e0b;
            --danger: #ef4444;
            --border: rgba(255, 255, 255, 0.08);
            --glow: 0 0 40px rgba(99, 102, 241, 0.15);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            line-height: 1.6;
        }

        .bg-pattern {
            position: fixed;
            inset: 0;
            background:
                radial-gradient(ellipse at 20% 20%, rgba(99, 102, 241, 0.08) 0%, transparent 50%),
                radial-gradient(ellipse at 80% 80%, rgba(139, 92, 246, 0.06) 0%, transparent 50%),
                radial-gradient(ellipse at 50% 50%, rgba(168, 85, 247, 0.04) 0%, transparent 70%);
            pointer-events: none;
            z-index: 0;
        }

        .container {
            position: relative;
            z-index: 1;
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem;
        }

        header {
            text-align: center;
            margin-bottom: 3rem;
            padding: 3rem 2rem;
            background: var(--bg-card);
            border-radius: 24px;
            border: 1px solid var(--border);
            box-shadow: var(--glow);
        }

        h1 {
            font-size: 2.75rem;
            font-weight: 800;
            background: var(--accent-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 0.75rem;
            letter-spacing: -0.02em;
        }

        .subtitle {
            color: var(--text-secondary);
            font-size: 1.1rem;
            font-weight: 400;
        }

        .score-legend {
            display: flex;
            justify-content: center;
            gap: 2rem;
            margin-top: 2rem;
            flex-wrap: wrap;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.9rem;
            color: var(--text-secondary);
        }

        .legend-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
        }

        .legend-dot.ideal {
            background: var(--success);
        }

        .legend-dot.solid {
            background: var(--accent-primary);
        }

        .legend-dot.average {
            background: var(--warning);
        }

        .legend-dot.poor {
            background: var(--danger);
        }

        .tabs {
            display: flex;
            justify-content: center;
            gap: 0.5rem;
            margin-bottom: 2rem;
            flex-wrap: wrap;
        }

        .tab {
            padding: 1rem 2rem;
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: 12px;
            color: var(--text-secondary);
            font-weight: 600;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .tab:hover {
            background: var(--bg-secondary);
            border-color: var(--accent-primary);
            color: var(--text-primary);
        }

        .tab.active {
            background: var(--accent-gradient);
            border-color: transparent;
            color: white;
            box-shadow: 0 4px 20px rgba(99, 102, 241, 0.4);
        }

        .results-container {
            display: none;
        }

        .results-container.active {
            display: block;
        }

        .results-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding: 0 0.5rem;
        }

        .results-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--text-primary);
        }

        .combo-count {
            font-size: 0.9rem;
            color: var(--text-muted);
            background: var(--bg-tertiary);
            padding: 0.5rem 1rem;
            border-radius: 8px;
        }

        .workout-grid {
            display: grid;
            gap: 1.25rem;
        }

        .workout-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 20px;
            padding: 1.5rem;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .workout-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: var(--accent-gradient);
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .workout-card:hover {
            transform: translateY(-4px);
            border-color: rgba(99, 102, 241, 0.3);
            box-shadow: var(--glow);
        }

        .workout-card:hover::before {
            opacity: 1;
        }

        .workout-card.rank-1 {
            border-color: rgba(34, 197, 94, 0.4);
            box-shadow: 0 0 30px rgba(34, 197, 94, 0.1);
        }

        .workout-card.rank-1::before {
            background: linear-gradient(90deg, #22c55e, #4ade80);
            opacity: 1;
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 1rem;
        }

        .rank-badge {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .rank-number {
            font-size: 1.25rem;
            font-weight: 800;
            color: var(--accent-primary);
        }

        .rank-1 .rank-number {
            color: var(--success);
        }

        .rank-label {
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            color: var(--text-muted);
        }

        .score-display {
            text-align: right;
        }

        .score-value {
            font-size: 2rem;
            font-weight: 800;
            line-height: 1;
        }

        .score-value.ideal {
            color: var(--success);
        }

        .score-value.solid {
            color: var(--accent-primary);
        }

        .score-value.average {
            color: var(--warning);
        }

        .score-value.poor {
            color: var(--danger);
        }

        .score-max {
            font-size: 0.875rem;
            color: var(--text-muted);
        }

        .exercises-list {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-bottom: 1.25rem;
        }

        .exercise-tag {
            background: rgba(99, 102, 241, 0.1);
            border: 1px solid rgba(99, 102, 241, 0.2);
            padding: 0.4rem 0.75rem;
            border-radius: 8px;
            font-size: 0.875rem;
            font-weight: 500;
            color: var(--text-primary);
            transition: all 0.2s ease;
        }

        .exercise-tag:hover {
            background: rgba(99, 102, 241, 0.2);
            border-color: rgba(99, 102, 241, 0.4);
        }

        .breakdown {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1rem;
        }

        .breakdown-item {
            background: var(--bg-tertiary);
            padding: 1rem;
            border-radius: 12px;
        }

        .breakdown-label {
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--text-muted);
            margin-bottom: 0.25rem;
        }

        .breakdown-score {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--text-primary);
        }

        .breakdown-bar {
            height: 4px;
            background: var(--bg-primary);
            border-radius: 2px;
            margin-top: 0.5rem;
            overflow: hidden;
        }

        .breakdown-fill {
            height: 100%;
            background: var(--accent-gradient);
            border-radius: 2px;
            transition: width 0.5s ease;
        }

        .breakdown-details {
            font-size: 0.75rem;
            color: var(--text-muted);
            margin-top: 0.5rem;
        }

        .detail-row {
            display: flex;
            justify-content: space-between;
            padding: 0.2rem 0;
        }

        .status-pass {
            color: var(--success);
        }

        .status-fail {
            color: var(--danger);
        }

        .status-partial {
            color: var(--warning);
        }

        .loading {
            text-align: center;
            padding: 4rem;
            color: var(--text-muted);
        }

        .loading-spinner {
            width: 48px;
            height: 48px;
            border: 3px solid var(--bg-tertiary);
            border-top-color: var(--accent-primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        @media (max-width: 768px) {
            .container {
                padding: 1rem;
            }

            h1 {
                font-size: 2rem;
            }

            .breakdown {
                grid-template-columns: 1fr;
            }

            .tabs {
                gap: 0.25rem;
            }

            .tab {
                padding: 0.75rem 1rem;
                font-size: 0.875rem;
            }

            .weight-sliders {
                flex-direction: column;
                gap: 1rem;
            }
        }

        .weight-sliders {
            display: flex;
            justify-content: center;
            gap: 2rem;
            margin-bottom: 2rem;
            padding: 1.5rem;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 16px;
            flex-wrap: wrap;
        }

        .weight-slider {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.5rem;
            min-width: 120px;
        }

        .weight-slider label {
            font-size: 0.875rem;
            font-weight: 600;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .weight-slider input[type="range"] {
            width: 100%;
            height: 6px;
            border-radius: 3px;
            background: var(--bg-tertiary);
            appearance: none;
            cursor: pointer;
        }

        .weight-slider input[type="range"]::-webkit-slider-thumb {
            appearance: none;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: var(--accent-gradient);
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(99, 102, 241, 0.4);
        }

        .weight-value {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--text-primary);
        }

        .view-toggle {
            display: flex;
            justify-content: center;
            gap: 0.5rem;
            margin-bottom: 1.5rem;
        }

        .view-toggle button {
            padding: 0.75rem 1.5rem;
            border: 1px solid var(--border);
            background: var(--bg-tertiary);
            color: var(--text-secondary);
            border-radius: 12px;
            font-size: 0.875rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .view-toggle button.active {
            background: var(--accent-gradient);
            color: white;
            border-color: transparent;
        }

        .frontier-container {
            display: none;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 1.5rem;
            margin-bottom: 2rem;
        }

        .frontier-container.visible {
            display: block;
        }

        .frontier-container h3 {
            text-align: center;
            margin-bottom: 1rem;
            color: var(--text-secondary);
            font-size: 1rem;
            font-weight: 600;
        }

        #frontierChart {
            width: 100%;
            height: 400px;
            background: var(--bg-secondary);
            border-radius: 12px;
        }

        .frontier-legend {
            display: flex;
            justify-content: center;
            gap: 2rem;
            margin-top: 1rem;
            font-size: 0.875rem;
        }

        .frontier-legend-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .legend-dot-frontier {
            width: 12px;
            height: 12px;
            border-radius: 50%;
        }

        .legend-dot-frontier.optimal {
            background: #22c55e;
        }

        .legend-dot-frontier.good {
            background: #6366f1;
        }

        .legend-dot-frontier.poor {
            background: #64748b;
        }
    </style>
</head>

<body>
    <div class="bg-pattern"></div>
    <div class="container">
        <header>
            <h1>Strength Efficiency Optimizer</h1>
            <p class="subtitle">Find the optimal workout combinations based on movement patterns, exercise potency, and
                synergy</p>
            <div class="score-legend">
                <div class="legend-item">
                    <div class="legend-dot ideal"></div>
                    <span>90-100: Ideal</span>
                </div>
                <div class="legend-item">
                    <div class="legend-dot solid"></div>
                    <span>70-89: Solid</span>
                </div>
                <div class="legend-item">
                    <div class="legend-dot average"></div>
                    <span>50-69: Average</span>
                </div>
                <div class="legend-item">
                    <div class="legend-dot poor"></div>
                    <span>&lt;50: Poor</span>
                </div>
            </div>
        </header>

        <div class="tabs">
            <button class="tab active" data-count="3">3 Exercises</button>
            <button class="tab" data-count="4">4 Exercises</button>
            <button class="tab" data-count="5">5 Exercises</button>
            <button class="tab" data-count="6">6 Exercises</button>
        </div>

        <div class="weight-sliders">
            <div class="weight-slider">
                <label>Coverage</label>
                <input type="range" id="weight-coverage" min="0" max="100" value="40">
                <span class="weight-value" id="weight-coverage-val">40</span>
            </div>
            <div class="weight-slider">
                <label>Potency</label>
                <input type="range" id="weight-potency" min="0" max="100" value="30">
                <span class="weight-value" id="weight-potency-val">30</span>
            </div>
            <div class="weight-slider">
                <label>Synergy</label>
                <input type="range" id="weight-synergy" min="0" max="100" value="30">
                <span class="weight-value" id="weight-synergy-val">30</span>
            </div>
        </div>

        <div class="view-toggle">
            <button id="view-rankings" class="active">Rankings</button>
            <button id="view-frontier">Efficiency Frontier</button>
        </div>

        <div class="frontier-container" id="frontierContainer">
            <h3>Potency vs Synergy Trade-off (Higher = Better)</h3>
            <canvas id="frontierChart"></canvas>
            <div class="frontier-legend">
                <div class="frontier-legend-item">
                    <div class="legend-dot-frontier optimal"></div>
                    <span>Pareto Optimal</span>
                </div>
                <div class="frontier-legend-item">
                    <div class="legend-dot-frontier good"></div>
                    <span>Top 100</span>
                </div>
                <div class="frontier-legend-item">
                    <div class="legend-dot-frontier poor"></div>
                    <span>Others</span>
                </div>
            </div>
        </div>

        <div id="results">
            <div class="loading">
                <div class="loading-spinner"></div>
                <p>Calculating optimal combinations...</p>
            </div>
        </div>
    </div>

    <script>
        // Exercise database (23 exercises - consolidated for efficiency)
        // exhaustion_cost: 0-3 (systemic/CNS fatigue), spinal_load: 0-3 (axial spinal stress)
        const exercises = [
            { name: "Back Squat", tier_points: 5, knee_dominant: 1, hip_dominant: 0, upper_push: 0, upper_pull: 0, plane: "NA", exhaustion_cost: 2, spinal_load: 3 },
            { name: "Front Squat", tier_points: 5, knee_dominant: 1, hip_dominant: 0, upper_push: 0, upper_pull: 0, plane: "NA", exhaustion_cost: 2, spinal_load: 2 },
            { name: "Conventional Deadlift", tier_points: 5, knee_dominant: 0, hip_dominant: 1, upper_push: 0, upper_pull: 0, plane: "NA", exhaustion_cost: 3, spinal_load: 3 },
            { name: "Trap Bar Deadlift", tier_points: 5, knee_dominant: 1, hip_dominant: 1, upper_push: 0, upper_pull: 0, plane: "NA", exhaustion_cost: 2, spinal_load: 2 },
            { name: "Barbell Bench Press", tier_points: 5, knee_dominant: 0, hip_dominant: 0, upper_push: 1, upper_pull: 0, plane: "horizontal", exhaustion_cost: 1, spinal_load: 0 },
            { name: "Standing Barbell OHP", tier_points: 5, knee_dominant: 0, hip_dominant: 0, upper_push: 1, upper_pull: 0, plane: "vertical", exhaustion_cost: 2, spinal_load: 2 },
            { name: "Chin-ups/Pull-ups", tier_points: 5, knee_dominant: 0, hip_dominant: 0, upper_push: 0, upper_pull: 1, plane: "vertical", exhaustion_cost: 1, spinal_load: 1 },
            { name: "DB Press (Flat/Incline)", tier_points: 4, knee_dominant: 0, hip_dominant: 0, upper_push: 1, upper_pull: 0, plane: "horizontal", exhaustion_cost: 1, spinal_load: 0 },
            { name: "Dips", tier_points: 4, knee_dominant: 0, hip_dominant: 0, upper_push: 1, upper_pull: 0, plane: "vertical", exhaustion_cost: 1, spinal_load: 0 },
            { name: "Barbell Row", tier_points: 4, knee_dominant: 0, hip_dominant: 0, upper_push: 0, upper_pull: 1, plane: "horizontal", exhaustion_cost: 2, spinal_load: 2 },
            { name: "Dumbbell Row", tier_points: 4, knee_dominant: 0, hip_dominant: 0, upper_push: 0, upper_pull: 1, plane: "horizontal", exhaustion_cost: 1, spinal_load: 0 },
            { name: "Bulgarian Split Squat", tier_points: 4, knee_dominant: 1, hip_dominant: 0, upper_push: 0, upper_pull: 0, plane: "NA", exhaustion_cost: 1, spinal_load: 1 },
            { name: "Romanian DL", tier_points: 4, knee_dominant: 0, hip_dominant: 1, upper_push: 0, upper_pull: 0, plane: "NA", exhaustion_cost: 1, spinal_load: 1 },
            { name: "Leg Press", tier_points: 4, knee_dominant: 1, hip_dominant: 0, upper_push: 0, upper_pull: 0, plane: "NA", exhaustion_cost: 1, spinal_load: 0 },
            { name: "Weighted Push-ups", tier_points: 4, knee_dominant: 0, hip_dominant: 0, upper_push: 1, upper_pull: 0, plane: "horizontal", exhaustion_cost: 1, spinal_load: 0 },
            { name: "Lat Pulldown", tier_points: 2, knee_dominant: 0, hip_dominant: 0, upper_push: 0, upper_pull: 1, plane: "vertical", exhaustion_cost: 0, spinal_load: 0 },
            { name: "Goblet Squat", tier_points: 2, knee_dominant: 1, hip_dominant: 0, upper_push: 0, upper_pull: 0, plane: "NA", exhaustion_cost: 0, spinal_load: 0 },
            { name: "Hyperextensions", tier_points: 2, knee_dominant: 0, hip_dominant: 1, upper_push: 0, upper_pull: 0, plane: "NA", exhaustion_cost: 0, spinal_load: 0 },
            { name: "Kettlebell Swing", tier_points: 2, knee_dominant: 0, hip_dominant: 1, upper_push: 0, upper_pull: 0, plane: "NA", exhaustion_cost: 0, spinal_load: 1 },
            { name: "Power Clean", tier_points: 4, knee_dominant: 1, hip_dominant: 1, upper_push: 0, upper_pull: 0, plane: "NA", exhaustion_cost: 2, spinal_load: 2 },
            { name: "Farmers Walk", tier_points: 1, knee_dominant: 0, hip_dominant: 0, upper_push: 0, upper_pull: 0, plane: "NA", exhaustion_cost: 0, spinal_load: 1 },
            { name: "Chest Supported Row", tier_points: 4, knee_dominant: 0, hip_dominant: 0, upper_push: 0, upper_pull: 1, plane: "horizontal", exhaustion_cost: 1, spinal_load: 0 },
            { name: "Inverted Row", tier_points: 2, knee_dominant: 0, hip_dominant: 0, upper_push: 0, upper_pull: 1, plane: "horizontal", exhaustion_cost: 0, spinal_load: 0 }
        ];

        // Scoring functions
        function scorePart1(workout) {
            const hasKnee = workout.some(e => e.knee_dominant);
            const hasHip = workout.some(e => e.hip_dominant);
            const hasPush = workout.some(e => e.upper_push);
            const hasPull = workout.some(e => e.upper_pull);

            let score = 0;
            if (hasKnee) score += 10;
            if (hasHip) score += 10;
            if (hasPush) score += 10;
            if (hasPull) score += 10;

            return { score, hasKnee, hasHip, hasPush, hasPull };
        }

        function scorePart2(workout) {
            // Separate exercises by tier
            const tier1and2 = workout.filter(e => e.tier_points >= 4); // Tier 1 (5) and Tier 2 (4)
            const tier3plus = workout.filter(e => e.tier_points < 4);  // Tier 3 and lower

            // Define movement patterns for redundancy check
            const patterns = ['knee_dominant', 'hip_dominant', 'upper_push', 'upper_pull'];

            // For Tier 1/2 exercises, only count the highest per pattern
            let tier1and2Potency = 0;
            const countedByPattern = {};

            // Sort by tier_points descending so we pick the best exercise first
            const sortedTier1and2 = [...tier1and2].sort((a, b) => b.tier_points - a.tier_points);

            for (const exercise of sortedTier1and2) {
                // Find which patterns this exercise belongs to
                const exercisePatterns = patterns.filter(p => exercise[p] === 1);

                if (exercisePatterns.length === 0) {
                    // Exercise doesn't hit any pattern (rare) - count it fully
                    tier1and2Potency += exercise.tier_points;
                } else {
                    // Check if any pattern is already counted
                    const alreadyCounted = exercisePatterns.some(p => countedByPattern[p]);

                    if (!alreadyCounted) {
                        // First Tier 1/2 exercise for this pattern - count it
                        tier1and2Potency += exercise.tier_points;
                        exercisePatterns.forEach(p => countedByPattern[p] = true);
                    }
                    // If already counted, this exercise gets 0 potency (redundancy penalty)
                }
            }

            // Tier 3+ exercises count fully (no redundancy penalty for lighter exercises)
            const tier3Potency = tier3plus.reduce((sum, e) => sum + e.tier_points, 0);

            const rawPotency = workout.reduce((sum, e) => sum + e.tier_points, 0);
            const effectivePotency = tier1and2Potency + tier3Potency;
            const score = Math.min(30, effectivePotency);

            return {
                score,
                rawPotency,
                effectivePotency,
                redundancyPenalty: rawPotency - effectivePotency
            };
        }

        function scorePart3(workout) {
            const workoutSize = workout.length;
            const pushCount = workout.filter(e => e.upper_push).length;
            const pullCount = workout.filter(e => e.upper_pull).length;

            // Push/Pull Balance
            let pushPullScore, pushPullStatus;
            if (pushCount === 0 && pullCount === 0) {
                pushPullScore = 0;
                pushPullStatus = 'no_upper';
            } else if (pullCount >= pushCount) {
                pushPullScore = 10;
                pushPullStatus = 'pass';
            } else {
                pushPullScore = 0;
                pushPullStatus = 'fail';
            }

            // Exhaustion Management (replaces old Spinal Management)
            // Thresholds scale with workout size
            const exhaustionBudget = workoutSize + 2; // 5 for 3ex, 6 for 4ex, etc.
            const maxSpinalLoad = workoutSize + 2;    // Same scaling

            const totalExhaustion = workout.reduce((sum, e) => sum + e.exhaustion_cost, 0);
            const totalSpinalLoad = workout.reduce((sum, e) => sum + e.spinal_load, 0);

            // Hard spinal threshold - workout is disqualified if exceeded
            const spinalDisqualified = totalSpinalLoad > maxSpinalLoad;

            // Exhaustion scoring (capped at 10 pts max penalty)
            let exhaustionScore, exhaustionStatus;
            if (totalExhaustion <= exhaustionBudget) {
                exhaustionScore = 10;
                exhaustionStatus = 'pass';
            } else if (totalExhaustion === exhaustionBudget + 1) {
                exhaustionScore = 5;
                exhaustionStatus = 'partial';
            } else {
                exhaustionScore = 0;
                exhaustionStatus = 'fail';
            }

            // Plane Coverage
            const hasVertical = workout.some(e => e.plane === 'vertical');
            const hasHorizontal = workout.some(e => e.plane === 'horizontal');
            let planeScore, planeStatus;
            if (hasVertical && hasHorizontal) {
                planeScore = 10;
                planeStatus = 'both';
            } else if (hasVertical || hasHorizontal) {
                planeScore = 5;
                planeStatus = 'one';
            } else {
                planeScore = 0;
                planeStatus = 'none';
            }

            return {
                score: pushPullScore + exhaustionScore + planeScore,
                pushPullScore, pushPullStatus, pushCount, pullCount,
                exhaustionScore, exhaustionStatus, totalExhaustion, exhaustionBudget,
                totalSpinalLoad, maxSpinalLoad, spinalDisqualified,
                planeScore, planeStatus
            };
        }

        // Get current weights from sliders (returns normalized weights that sum to 1)
        function getWeights() {
            const coverageEl = document.getElementById('weight-coverage');
            const potencyEl = document.getElementById('weight-potency');
            const synergyEl = document.getElementById('weight-synergy');

            // Parse values, defaulting only for NaN (not for 0)
            const coverage = coverageEl ? parseInt(coverageEl.value, 10) : 40;
            const potency = potencyEl ? parseInt(potencyEl.value, 10) : 30;
            const synergy = synergyEl ? parseInt(synergyEl.value, 10) : 30;

            const total = coverage + potency + synergy;
            // Prevent division by zero - if all are 0, use equal weights
            if (total === 0) {
                return { coverage: 1 / 3, potency: 1 / 3, synergy: 1 / 3 };
            }
            return {
                coverage: coverage / total,
                potency: potency / total,
                synergy: synergy / total
            };
        }

        function scoreWorkout(workout, weights) {
            const part1 = scorePart1(workout);
            const part2 = scorePart2(workout);
            const part3 = scorePart3(workout);

            // Normalize each part to 0-1 scale, then apply weights
            const norm1 = part1.score / 40;  // Coverage: max 40
            const norm2 = part2.score / 30;  // Potency: max 30
            const norm3 = part3.score / 30;  // Synergy: max 30

            // Weighted total scaled to 100
            const total = Math.round((norm1 * weights.coverage + norm2 * weights.potency + norm3 * weights.synergy) * 100);

            return {
                total,
                disqualified: part3.spinalDisqualified,
                part1, part2, part3,
                exercises: workout.map(e => e.name)
            };
        }

        // Generate combinations
        function* combinations(arr, k) {
            if (k === 0) { yield []; return; }
            if (arr.length < k) return;

            const [first, ...rest] = arr;
            for (const combo of combinations(rest, k - 1)) {
                yield [first, ...combo];
            }
            yield* combinations(rest, k);
        }

        function findTopCombinations(nExercises, topN = 10) {
            const weights = getWeights();
            const allCombos = [...combinations(exercises, nExercises)];
            const scored = allCombos.map(combo => scoreWorkout(combo, weights));
            // Filter out disqualified workouts (exceeded spinal threshold)
            const qualified = scored.filter(w => !w.disqualified);
            qualified.sort((a, b) => b.total - a.total);
            return {
                results: qualified.slice(0, topN),
                totalCombos: allCombos.length,
                qualifiedCombos: qualified.length,
                disqualifiedCombos: scored.length - qualified.length
            };
        }

        // UI Functions
        function getScoreClass(score) {
            if (score >= 90) return 'ideal';
            if (score >= 70) return 'solid';
            if (score >= 50) return 'average';
            return 'poor';
        }

        function getStatusClass(status) {
            if (status === 'pass' || status === 'both') return 'status-pass';
            if (status === 'fail') return 'status-fail';
            return 'status-partial';
        }

        function renderResults(nExercises) {
            const { results, totalCombos, qualifiedCombos, disqualifiedCombos } = findTopCombinations(nExercises, 10);

            let html = `
                <div class="results-header">
                    <h2 class="results-title">Top 10 ${nExercises}-Exercise Combinations</h2>
                    <span class="combo-count">${qualifiedCombos.toLocaleString()} valid (${disqualifiedCombos} disqualified for spinal load)</span>
                </div>
                <div class="workout-grid">
            `;

            results.forEach((result, index) => {
                const rank = index + 1;
                const scoreClass = getScoreClass(result.total);

                html += `
                    <div class="workout-card${rank === 1 ? ' rank-1' : ''}">
                        <div class="card-header">
                            <div class="rank-badge">
                                <span class="rank-number">#${rank}</span>
                                <span class="rank-label">Rank</span>
                            </div>
                            <div class="score-display">
                                <div class="score-value ${scoreClass}">${result.total}</div>
                                <div class="score-max">/ 100</div>
                            </div>
                        </div>
                        
                        <div class="exercises-list">
                            ${result.exercises.map(e => `<span class="exercise-tag">${e}</span>`).join('')}
                        </div>
                        
                        <div class="breakdown">
                            <div class="breakdown-item">
                                <div class="breakdown-label">Movement Coverage</div>
                                <div class="breakdown-score">${result.part1.score} / 40</div>
                                <div class="breakdown-bar">
                                    <div class="breakdown-fill" style="width: ${(result.part1.score / 40) * 100}%"></div>
                                </div>
                                <div class="breakdown-details">
                                    <div class="detail-row">
                                        <span>Knee</span>
                                        <span class="${result.part1.hasKnee ? 'status-pass' : 'status-fail'}">${result.part1.hasKnee ? '✓' : '✗'}</span>
                                    </div>
                                    <div class="detail-row">
                                        <span>Hip</span>
                                        <span class="${result.part1.hasHip ? 'status-pass' : 'status-fail'}">${result.part1.hasHip ? '✓' : '✗'}</span>
                                    </div>
                                    <div class="detail-row">
                                        <span>Push</span>
                                        <span class="${result.part1.hasPush ? 'status-pass' : 'status-fail'}">${result.part1.hasPush ? '✓' : '✗'}</span>
                                    </div>
                                    <div class="detail-row">
                                        <span>Pull</span>
                                        <span class="${result.part1.hasPull ? 'status-pass' : 'status-fail'}">${result.part1.hasPull ? '✓' : '✗'}</span>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="breakdown-item">
                                <div class="breakdown-label">Exercise Potency</div>
                                <div class="breakdown-score">${result.part2.score} / 30</div>
                                <div class="breakdown-bar">
                                    <div class="breakdown-fill" style="width: ${(result.part2.score / 30) * 100}%"></div>
                                </div>
                                <div class="breakdown-details">
                                    <div class="detail-row">
                                        <span>Raw Total</span>
                                        <span>${result.part2.rawPotency} pts</span>
                                    </div>
                                    <div class="detail-row">
                                        <span>Redundancy</span>
                                        <span class="${result.part2.redundancyPenalty > 0 ? 'status-fail' : 'status-pass'}">${result.part2.redundancyPenalty > 0 ? '-' + result.part2.redundancyPenalty : '0'}</span>
                                    </div>
                                    <div class="detail-row">
                                        <span>Effective</span>
                                        <span>${result.part2.effectivePotency} pts</span>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="breakdown-item">
                                <div class="breakdown-label">Synergy & Context</div>
                                <div class="breakdown-score">${result.part3.score} / 30</div>
                                <div class="breakdown-bar">
                                    <div class="breakdown-fill" style="width: ${(result.part3.score / 30) * 100}%"></div>
                                </div>
                                <div class="breakdown-details">
                                    <div class="detail-row">
                                        <span>Push/Pull</span>
                                        <span class="${getStatusClass(result.part3.pushPullStatus)}">${result.part3.pushPullScore}/10</span>
                                    </div>
                                    <div class="detail-row">
                                        <span>Exhaustion</span>
                                        <span class="${getStatusClass(result.part3.exhaustionStatus)}">${result.part3.totalExhaustion}/${result.part3.exhaustionBudget}</span>
                                    </div>
                                    <div class="detail-row">
                                        <span>Spinal</span>
                                        <span class="${result.part3.totalSpinalLoad <= result.part3.maxSpinalLoad ? 'status-pass' : 'status-fail'}">${result.part3.totalSpinalLoad}/${result.part3.maxSpinalLoad}</span>
                                    </div>
                                    <div class="detail-row">
                                        <span>Planes</span>
                                        <span class="${getStatusClass(result.part3.planeStatus)}">${result.part3.planeScore}/10</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });

            html += '</div>';
            document.getElementById('results').innerHTML = html;
        }

        // Tab switching
        document.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', () => {
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                tab.classList.add('active');
                const count = parseInt(tab.dataset.count);

                document.getElementById('results').innerHTML = `
                    <div class="loading">
                        <div class="loading-spinner"></div>
                        <p>Calculating optimal combinations...</p>
                    </div>
                `;

                // Use setTimeout to allow UI to update before heavy computation
                setTimeout(() => renderResults(count), 50);
            });
        });

        // Track current exercise count for re-renders
        let currentExerciseCount = 3;

        // Weight slider event listeners
        ['coverage', 'potency', 'synergy'].forEach(type => {
            const slider = document.getElementById(`weight-${type}`);
            const valueDisplay = document.getElementById(`weight-${type}-val`);
            slider.addEventListener('input', () => {
                valueDisplay.textContent = slider.value;
            });
            slider.addEventListener('change', () => {
                // Re-render results when slider changes
                document.getElementById('results').innerHTML = `
                    <div class="loading">
                        <div class="loading-spinner"></div>
                        <p>Recalculating...</p>
                    </div>
                `;
                setTimeout(() => renderResults(currentExerciseCount), 50);
            });
        });

        // Update currentExerciseCount when tabs are clicked
        document.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', () => {
                currentExerciseCount = parseInt(tab.dataset.count);
            });
        });

        // Initial render
        setTimeout(() => renderResults(3), 100);

        // View toggle handling
        let currentView = 'rankings';
        const viewRankings = document.getElementById('view-rankings');
        const viewFrontier = document.getElementById('view-frontier');
        const frontierContainer = document.getElementById('frontierContainer');
        const resultsContainer = document.getElementById('results');

        viewRankings.addEventListener('click', () => {
            viewRankings.classList.add('active');
            viewFrontier.classList.remove('active');
            frontierContainer.classList.remove('visible');
            resultsContainer.style.display = 'block';
            currentView = 'rankings';
        });

        viewFrontier.addEventListener('click', () => {
            viewFrontier.classList.add('active');
            viewRankings.classList.remove('active');
            frontierContainer.classList.add('visible');
            resultsContainer.style.display = 'none';
            currentView = 'frontier';
            renderFrontierChart(currentExerciseCount);
        });

        // Efficiency Frontier Chart
        function calculateParetoFrontier(points) {
            // Sort by potency descending
            const sorted = [...points].sort((a, b) => b.potency - a.potency);
            const frontier = [];
            let maxSynergy = -Infinity;

            for (const point of sorted) {
                if (point.synergy > maxSynergy) {
                    frontier.push(point);
                    maxSynergy = point.synergy;
                }
            }
            return frontier;
        }

        function renderFrontierChart(nExercises) {
            const canvas = document.getElementById('frontierChart');
            const ctx = canvas.getContext('2d');

            // Set canvas size for high DPI
            const rect = canvas.parentElement.getBoundingClientRect();
            const dpr = window.devicePixelRatio || 1;
            canvas.width = rect.width * dpr;
            canvas.height = 400 * dpr;
            canvas.style.width = rect.width + 'px';
            canvas.style.height = '400px';
            ctx.scale(dpr, dpr);

            const width = rect.width;
            const height = 400;
            const padding = { top: 40, right: 30, bottom: 50, left: 60 };
            const plotWidth = width - padding.left - padding.right;
            const plotHeight = height - padding.top - padding.bottom;

            // Get all combinations with potency/synergy scores
            const allCombos = [...combinations(exercises, nExercises)];
            const weights = getWeights();
            const points = allCombos
                .map(combo => {
                    const result = scoreWorkout(combo, weights);
                    if (result.disqualified) return null;
                    return {
                        potency: result.part2.score,
                        synergy: result.part3.score,
                        exercises: result.exercises,
                        total: result.total
                    };
                })
                .filter(p => p !== null);

            // Sort by total for top 100
            const sortedByTotal = [...points].sort((a, b) => b.total - a.total);
            const top100 = new Set(sortedByTotal.slice(0, 100));

            // Calculate Pareto frontier
            const frontier = calculateParetoFrontier(points);
            const frontierSet = new Set(frontier);

            // Clear canvas
            ctx.fillStyle = '#12121a';
            ctx.fillRect(0, 0, width, height);

            // Draw grid
            ctx.strokeStyle = 'rgba(255, 255, 255, 0.1)';
            ctx.lineWidth = 1;
            for (let i = 0; i <= 6; i++) {
                const x = padding.left + (plotWidth / 6) * i;
                const y = padding.top + (plotHeight / 6) * i;
                ctx.beginPath();
                ctx.moveTo(x, padding.top);
                ctx.lineTo(x, height - padding.bottom);
                ctx.stroke();
                ctx.beginPath();
                ctx.moveTo(padding.left, y);
                ctx.lineTo(width - padding.right, y);
                ctx.stroke();
            }

            // Axis labels
            ctx.fillStyle = '#94a3b8';
            ctx.font = '12px Inter, sans-serif';
            ctx.textAlign = 'center';
            ctx.fillText('Potency Score (0-30)', width / 2, height - 10);
            ctx.save();
            ctx.translate(20, height / 2);
            ctx.rotate(-Math.PI / 2);
            ctx.fillText('Synergy Score (0-30)', 0, 0);
            ctx.restore();

            // Scale functions
            const scaleX = (v) => padding.left + (v / 30) * plotWidth;
            const scaleY = (v) => height - padding.bottom - (v / 30) * plotHeight;

            // Axis tick labels
            ctx.fillStyle = '#64748b';
            ctx.font = '10px Inter';
            ctx.textAlign = 'center';
            for (let v = 0; v <= 30; v += 5) {
                ctx.fillText(v.toString(), scaleX(v), height - padding.bottom + 15);
            }
            ctx.textAlign = 'right';
            for (let v = 0; v <= 30; v += 5) {
                ctx.fillText(v.toString(), padding.left - 8, scaleY(v) + 4);
            }

            // Draw points (poor first, then good, then optimal)
            points.forEach(p => {
                if (frontierSet.has(p) || top100.has(p)) return;
                ctx.beginPath();
                ctx.arc(scaleX(p.potency), scaleY(p.synergy), 3, 0, Math.PI * 2);
                ctx.fillStyle = 'rgba(100, 116, 139, 0.4)';
                ctx.fill();
            });

            points.forEach(p => {
                if (frontierSet.has(p) || !top100.has(p)) return;
                ctx.beginPath();
                ctx.arc(scaleX(p.potency), scaleY(p.synergy), 4, 0, Math.PI * 2);
                ctx.fillStyle = 'rgba(99, 102, 241, 0.8)';
                ctx.fill();
            });

            // Draw frontier points and line
            if (frontier.length > 1) {
                ctx.strokeStyle = '#22c55e';
                ctx.lineWidth = 2;
                ctx.beginPath();
                ctx.moveTo(scaleX(frontier[0].potency), scaleY(frontier[0].synergy));
                for (let i = 1; i < frontier.length; i++) {
                    ctx.lineTo(scaleX(frontier[i].potency), scaleY(frontier[i].synergy));
                }
                ctx.stroke();
            }

            frontier.forEach(p => {
                ctx.beginPath();
                ctx.arc(scaleX(p.potency), scaleY(p.synergy), 6, 0, Math.PI * 2);
                ctx.fillStyle = '#22c55e';
                ctx.fill();
                ctx.strokeStyle = 'white';
                ctx.lineWidth = 2;
                ctx.stroke();
            });

            // Title with counts
            ctx.fillStyle = '#f8fafc';
            ctx.font = 'bold 14px Inter';
            ctx.textAlign = 'center';
            ctx.fillText(`${nExercises}-Exercise Workouts: ${points.length} valid, ${frontier.length} Pareto optimal`, width / 2, 20);
        }

        // Update frontier when tabs/sliders change
        document.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', () => {
                if (currentView === 'frontier') {
                    setTimeout(() => renderFrontierChart(currentExerciseCount), 100);
                }
            });
        });

        ['coverage', 'potency', 'synergy'].forEach(type => {
            document.getElementById(`weight-${type}`).addEventListener('change', () => {
                if (currentView === 'frontier') {
                    setTimeout(() => renderFrontierChart(currentExerciseCount), 100);
                }
            });
        });

        // Register Service Worker for offline support
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./sw.js')
                    .then(registration => {
                        console.log('SW registered:', registration.scope);
                    })
                    .catch(error => {
                        console.log('SW registration failed:', error);
                    });
            });
        }
    </script>
</body>

</html>